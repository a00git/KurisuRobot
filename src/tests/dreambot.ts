jest.mock('node-fetch');

import { getDBsHealth } from '../kurisu/dreambot';
import fetch from 'node-fetch';

const { Response } = jest.requireActual('node-fetch');

describe('dreambot', () => {
  test('fetched health should be 4.5', async () => {
    const snapshot = '<HEAD><link rel="shortcut icon" href="DreamingRobot.png" /><meta name="google-site-verification" content="r3XXPxw4LxXnSZLMjoMuVCfcwWHGR7CYFzO6Y3WlED0" /><meta http-equiv="refresh" content="900"> <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/><TITLE>Health Report - Dreambo漹另 #60</TITLE><style>.heart:nth-of-type(1){animation-delay:100.6ms; position:relative; z-index:5;} .heart:nth-of-type(2){animation-delay:201.2ms; position:relative; z-index:4;} .heart:nth-of-type(3){animation-delay:301.8ms; position:relative; z-index:3;} .heart:nth-of-type(4){animation-delay:402.4ms; position:relative; z-index:2;} .heart:nth-of-type(5){animation-delay:503ms; position:relative; z-index:1;} @keyframes heartbeat{0%{transform:scale(1.075);}20%{transform:scale(1);}40%{transform:scale(1.15);}60%{transform:scale(1);}80%{transform:scale(1);}100%{transform:scale(1.075);}} @keyframes float{0%{transform: translatey(0vh);} 50%{transform: translatey(-1vh);} 100%{transform: translatey(0vh);}} .heart{animation:heartbeat 2.514s infinite;} healthglow{text-shadow:0px 0.25vh 1vmin 0.025vmin #721d16;} #birthcert{box-shadow: 0px 0.025vh 1.5vmin #721d16; text-align:center; border-radius:3vmin; background:#fdeed4; padding:2vmin; width:60vw; color:#721d16;} .status{font-size:1vmin; animation: float 1.173s ease-in-out infinite;} nickname{font-size:5vmin;} generation{font-size:3.5vmin;} birthstuff{font-size:3vmin;} footer{position:fixed; bottom:2vmin; left:0; width:100%; font-size:2vmin;} line{content:"";border:0.025vh solid #721d16;margin:0.5vmin auto;display:block;} #profileid{max-width:15vw; max-height:15vh; border-radius:50%;} #statusid{max-width:1vw; max-height:1vh;}</style></HEAD><body style="background-color:#fbdaac; font-family:helvetica;"><script>var blurred = false; window.onblur = function() { blurred = true; }; window.onfocus = function() { blurred && (location.reload()); };</script><center><a href="https://t.me/DreamingStats" style="text-decoration: none"><div id="birthcert"><img src="https://cdn1.telesco.pe/file/DIXxZ-thkjrrP2tj051upk4BmkLJGKORzM-vLuxfHwGbN0f0Hv53uCLh_w0lAlu4wrFL8yl1F0CfoYOMDglG95RRWz8RCTl0Novn9VfnUzr3KwfTz4mfrSARx0IYcz9lNOcky80SQ5B7phgDyrwaA16YvsnmOSac9W3NO2-dyAfWm_C06vpov4fZuHQ-kkoTsJRLwgMWGPEzInC_Ht9PKRgAbcOfWm1kHb6JGv7hX-DgYXkyAN2kNLXMe368BVTAlz5pVLeXGflALDgGqHFZ_PhLHJ6R4BlF1yJwjcmDcy-FBykdROUoi1eCt61dFCapAA_VTWppw-BLvltlOGMrAg.jpg" alt="DreamBaka" id="profileid"><br><nickname><u>DreamBaka</u></nickname><br><generation>Generation 60 female Dreambo漹另</generation><br><birthstuff><i>Birth date:</i><br>Fri Dec 13 07:19:10 PST 2019<line></line><b>It will be moderately easy to keep</b> <b>DreamBaka</b> <b>from starvation. Her vitality is slightly higher than average.</b></birthstuff></div></a><p><a href="https://DreamingRobot.HerokuApp.com/Care"><img class="heart" src= "Full heart.png" alt="Full heart" width=12% align="middle"><img class="heart" src= "Full heart.png" alt="Full heart" width=12% align="middle"><img class="heart" src= "Full heart.png" alt="Full heart" width=12% align="middle"><img class="heart" src= "Full heart.png" alt="Full heart" width=12% align="middle"><img class="heart" src= "Half heart.png" alt="Half heart" width=12% align="middle"></a></p><footer><a href="https://DreamingRobot.HerokuApp.com/Tech" style="text-decoration:none; color:#212121">This page automatically refreshes to check for updates.<br>The tab title will change for urgent information.</a></footer></center>';
    (fetch as jest.MockedFunction<typeof fetch>).mockReturnValue(Promise.resolve(new Response(snapshot)));
    const expectedHealth = 4.5;

    const health = await getDBsHealth();

    expect(fetch).toHaveBeenCalledTimes(1);
    expect(fetch).toHaveBeenCalledWith('https://dreamingrobot.herokuapp.com/');
    expect(health).toBe(expectedHealth);
  });

  test('fetched health should be 3', async () => {
    const snapshot = '<HEAD><link rel="shortcut icon" href="DreamingRobot.png" /><meta name="google-site-verification" content="r3XXPxw4LxXnSZLMjoMuVCfcwWHGR7CYFzO6Y3WlED0" /><meta http-equiv="refresh" content="900"> <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/><TITLE>Health Report - Dreambo漹另 #60</TITLE><style>.heart:nth-of-type(1){animation-delay:121.333ms; position:relative; z-index:5;} .heart:nth-of-type(2){animation-delay:242.666ms; position:relative; z-index:4;} .heart:nth-of-type(3){animation-delay:364ms; position:relative; z-index:3;} .heart:nth-of-type(4){animation-delay:485.333ms; position:relative; z-index:2;} .heart:nth-of-type(5){animation-delay:606.666ms; position:relative; z-index:1;} @keyframes heartbeat{0%{transform:scale(1.075);}20%{transform:scale(1);}40%{transform:scale(1.15);}60%{transform:scale(1);}80%{transform:scale(1);}100%{transform:scale(1.075);}} @keyframes float{0%{transform: translatey(0vh);} 50%{transform: translatey(-1vh);} 100%{transform: translatey(0vh);}} .heart{animation:heartbeat 1.82s infinite;} healthglow{text-shadow:0px 0.25vh 1vmin 0.025vmin #721d16;} #birthcert{box-shadow: 0px 0.025vh 1.5vmin #721d16; text-align:center; border-radius:3vmin; background:#fdeed4; padding:2vmin; width:60vw; color:#721d16;} .status{font-size:1vmin; animation: float 0.849s ease-in-out infinite;} nickname{font-size:5vmin;} generation{font-size:3.5vmin;} birthstuff{font-size:3vmin;} footer{position:fixed; bottom:2vmin; left:0; width:100%; font-size:2vmin;} line{content:"";border:0.025vh solid #721d16;margin:0.5vmin auto;display:block;} #profileid{max-width:15vw; max-height:15vh; border-radius:50%;} #statusid{max-width:1vw; max-height:1vh;}</style></HEAD><body style="background-color:#fbdaac; font-family:helvetica;"><script>var blurred = false; window.onblur = function() { blurred = true; }; window.onfocus = function() { blurred && (location.reload()); };</script><center><a href="https://t.me/DreamingStats" style="text-decoration: none"><div id="birthcert"><img src="https://cdn1.telesco.pe/file/DIXxZ-thkjrrP2tj051upk4BmkLJGKORzM-vLuxfHwGbN0f0Hv53uCLh_w0lAlu4wrFL8yl1F0CfoYOMDglG95RRWz8RCTl0Novn9VfnUzr3KwfTz4mfrSARx0IYcz9lNOcky80SQ5B7phgDyrwaA16YvsnmOSac9W3NO2-dyAfWm_C06vpov4fZuHQ-kkoTsJRLwgMWGPEzInC_Ht9PKRgAbcOfWm1kHb6JGv7hX-DgYXkyAN2kNLXMe368BVTAlz5pVLeXGflALDgGqHFZ_PhLHJ6R4BlF1yJwjcmDcy-FBykdROUoi1eCt61dFCapAA_VTWppw-BLvltlOGMrAg.jpg" alt="DreamBaka" id="profileid"><br><nickname><u>DreamBaka</u></nickname><br><generation>Generation 60 female Dreambo漹另</generation><br><birthstuff><i>Birth date:</i><br>Fri Dec 13 07:19:10 PST 2019<line></line><b>It will be moderately easy to keep</b> <b>DreamBaka</b> <b>from starvation. Her vitality is slightly higher than average.</b></birthstuff></div></a><p><a href="https://DreamingRobot.HerokuApp.com/Care"><img class="heart" src= "Full heart.png" alt="Full heart" width=12% align="middle"><img class="heart" src= "Full heart.png" alt="Full heart" width=12% align="middle"><img class="heart" src= "Full heart.png" alt="Full heart" width=12% align="middle"><img src= "Empty heart.png" alt="Empty heart" width=12% align="middle"><img src= "Empty heart.png" alt="Empty heart" width=12% align="middle"></a></p><footer><a href="https://DreamingRobot.HerokuApp.com/Tech" style="text-decoration:none; color:#212121">This page automatically refreshes to check for updates.<br>The tab title will change for urgent information.</a></footer></center>';
    (fetch as jest.MockedFunction<typeof fetch>).mockReturnValue(Promise.resolve(new Response(snapshot)));
    const expectedHealth = 3;

    const health = await getDBsHealth();

    expect(fetch).toHaveBeenCalledTimes(2);
    expect(fetch).toHaveBeenCalledWith('https://dreamingrobot.herokuapp.com/');
    expect(health).toBe(expectedHealth);
  });
});
